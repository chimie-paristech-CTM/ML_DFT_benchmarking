import os
from glob import glob
import shutil
import re


def extract_geom_xyz(lines):
    """
            Extract geometry, charge and multiplicity from a XYZ file generated by autodE

            Args:
                lines (list): Lines of XYZ file

            Return:
                geom (list): Geometry
            """

    charge_match = re.search(r'charge\s*=\s*(\d+)', lines[1])
    mult_match = re.search(r'mult\s*=\s*(\d+)', lines[1])

    charge = int(charge_match.group(1))
    multiplicity = int(mult_match.group(1))

    geom = [f"{charge}  {multiplicity}\n"]
    for line in lines[2:]:
        if line.isspace():
            break
        geom.append(line)

    return geom


def create_irc_input_file(name, geom):
    """
        Function to generate input of Gaussian
        Args:
            name (str): final name of the input
            geom (list): list with the coordinates
        Return:
            Create input file for IRC
        """

    directions = ['forward', 'reverse']

    for direction in directions:

        route_link = f"# cam-b3lyp 6-311++G**  IRC=(calcfc, maxpoints=25, recalc=3, {direction}) nosymm EmpiricalDispersion=GD3BJ"
        with open(f"{name}_{direction}.com", 'w') as file:
            file.write(f"{route_link}\n\n")
            file.write("IRC validation\n\n")
            for coordinate in geom:
                file.write(f"{coordinate}")
            file.write('\n\n')


def main_function():

    pwd = os.getcwd()
    ou_folder = os.path.join(pwd, 'reaction/output')
    if os.path.exists(ou_folder):

        os.chdir(ou_folder)
        ts_files = glob('TS*')

        if len(ts_files) > 0:
            ts_file = [ts_file for ts_file in ts_files if not 'imag_mode' in ts_file][0]

            with open(ts_file, 'r') as file:
                lines = file.readlines()

            geom = extract_geom_xyz(lines)

            os.makedirs('IRC')
            irc_dir = os.path.join(ou_folder, 'IRC')

            name = ts_file.split('.')[0]
            shutil.copy(ts_file, irc_dir)
            os.chdir(irc_dir)
            create_irc_input_file(name, geom)


if __name__ == "__main__":
    main_function()
